name: Publish
on:
  workflow_dispatch:
    inputs:
       projects:
        description: "Project(s) to publish (to Akash)"
        required: true
       chain_type:
        description: "Chain Type to publish (default to mainnet when more than 1 was configured)"
        required: false
       base_path:
        description: "Override basePath in next.config.js (default to basePath in chainConfig)"
        required: false
       confirm:
        description: "enter \"CONFIRM\" to process"
        required: true
concurrency:
  group: publish-to-akash
  cancel-in-progress: true
defaults:
  run:
    shell: bash
jobs:
  validate-projects:
    uses: ${{ github.repository }}/.github/workflows/validate-projects.yml@v1
    with:
      projects: ${{ github.event.inputs.projects }}
  validate-chain-type:
    uses: ${{ github.repository }}/.github/workflows/validate-chain-type.yml@v1
    with:
      projects: ${{ github.event.inputs.projects }}
      chain_type: ${{ github.event.inputs.chain_type }}
  publish:
    runs-on: ubuntu-latest
    needs: [validate-projects, validate-chain-type]
    if: ${{ needs.validate-projects.outputs.projects != '[]' }}
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        project: ${{ fromJSON(needs.validate-projects.outputs.projects) }}
        chain_type: [needs.validate-chain-type.chain_type]
        sha_short: [steps.vars.outputs.sha_short]
        base_path: [github.event.inputs.base_path]
    name: Publish ${{ matrix.project }}
    steps:
      - uses: actions/checkout@v3
      - run: echo 'sha_short='$(git rev-parse --short HEAD) | tee -a $GITHUB_OUTPUT
        id: vars
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to DockerHub ðŸ‘¤
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Create the builder
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          build-args: |
            PROJECT_NAME=${{ matrix.project }}
            NEXT_PUBLIC_CHAIN_TYPE=${{ matrix.chain_type }}
            NEXT_PUBLIC_BANNERS_JSON=${{ secrets.BANNERS_JSON }}
            TURBO_TEAM=${{ secrets.TURBO_TEAM }}
            TURBO_TOKEN=${{ secrets.TURBO_TOKEN }}
            NEXT_PUBLIC_SENTRY_DSN=${{ secrets.SENTRY_DSN }}
            SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}
            BASE_PATH=${{ matrix.base_path }}
          target: web
          tags: |
            forbole/big-dipper-2.0-cosmos:monorepo-${{ matrix.project }}-${{ matrix.chain_type }}-${{ matrix.sha_short }}
            forbole/big-dipper-2.0-cosmos:monorepo-${{ matrix.project }}-${{ matrix.chain_type }}-latest
      - name: Publish to akash
        run: >
          curl -i -X POST -H "Content-Type: application/json"
          -d '{"parameters":{"tag": "monorepo-${{ matrix.project }}-${{ matrix.chain_type }}-${{ matrix.sha_short }}"}}'
          -k ${{ secrets.WEBHOOK_URL }}/${{ matrix.project }}-${{ matrix.chain_type }}
          -u "deploy:${{ secrets.AKASH_WEBHOOK_SECRET }}" | tee -a $GITHUB_STEP_SUMMARY
