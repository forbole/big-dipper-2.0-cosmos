name: Preview
on:
  workflow_dispatch:
    inputs:
       projects:
        description: "Project to publish (to Vercel)"
        required: true
       chain_type:
        description: "Chain Type to publish (default to mainnet when more than 1 was configured)"
        required: false
       base_path:
        description: "Override basePath in next.config.js (default to basePath in chainConfig)"
        required: false
defaults:
  run:
    shell: bash
jobs:
  validate-projects:
    uses: ${{ github.repository }}/.github/workflows/validate-projects.yml@v1
    with:
      projects: ${{ github.event.inputs.projects }}
  validate-chain-type:
    uses: ${{ github.repository }}/.github/workflows/validate-chain-type.yml@v1
    with:
      projects: ${{ github.event.inputs.projects }}
      chain_type: ${{ github.event.inputs.chain_type }}
  publish:
    runs-on: ubuntu-latest
    needs: [validate-projects, validate-chain-type]
    if: ${{ needs.validate-projects.outputs.projects != '[]' }}
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        project: ${{ fromJSON(needs.validate-projects.outputs.projects) }}
        chain_type: [needs.validate-chain-type.chain_type]
        base_path: [github.event.inputs.base_path]
    name: Publish ${{ matrix.project }}
    steps:
      - uses: actions/checkout@v3
      - name: Insall Vercel CLI
        run: npm i -g vercel
      - name: Generate vercel.json
        run: |
          node <<EOF > vercel.json
          const projectName = process.env.PROJECT_NAME || 'web';
          const chainType = process.env.NEXT_PUBLIC_CHAIN_TYPE?.toLowerCase() || 'mainnet';
          const config = {
            buildCommand: 'NEXT_PUBLIC_CHAIN_TYPE=' + chainType + ' BASE_PATH=' + process.env.BASE_PATH +
              ' yarn turbo run build --filter=' + projectName + '...',
            outputDirectory: 'apps/' + projectName + '/.next',
            installCommand: 'yarn workspaces focus --production ' + projectName + ' && yarn add typescript -D',
            devCommand: 'yarn turbo run dev --filter=' + projectName + '...',
            framework: 'nextjs',
            ignoreCommand: 'echo always build && exit 1',
            redirects: process.env.BASE_PATH !== "/" && /^web-/.test(projectName)
              ? [{ source: '/', destination: '/' + projectName.replace(/^web-/, '') }]
              : [],
          };
          console.log(JSON.stringify(config, null, 2));
          EOF
        env:
          PROJECT_NAME: ${{ matrix.project }}
          NEXT_PUBLIC_CHAIN_TYPE: ${{ matrix.chain_type }}
          BASE_PATH: ${{ matrix.base_path }}
      - name: Deploy preview to Vercel
        run: vercel -t ${{ secrets.VERCEL_TOKEN }} | tee -a $GITHUB_STEP_SUMMARY
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
