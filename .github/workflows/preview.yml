name: Preview
on:
  workflow_dispatch:
    inputs:
       project_name:
        description: "Project to publish"
        required: true
       chain_type:
        description: "Chain Type to publish"
        required: false
        default: mainnet
jobs:
  publish:
    runs-on: ubuntu-latest
    if: startsWith('web-', ${{ github.event.inputs.project_name }})
    env:
        PROJECT_NAME: ${{ github.event.inputs.project_name }}
        NEXT_PUBLIC_CHAIN_TYPE: ${{ github.event.inputs.chain_type }}
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v3
      - name: Insall Vercel CLI
        run: npm i -g vercel
      - name: Generate vercel.json
        run: |
          'node <<EOF'
          'const { writeFileSync } = require(`fs`);'
          'const projectName = process.env.PROJECT_NAME || `web`;'
          'const chainType = process.env.NEXT_PUBLIC_CHAIN_TYPE || `mainnet`;'
          'const config = {'
          '  buildCommand: `NEXT_PUBLIC_CHAIN_TYPE=${chainType} yarn turbo run build --filter=${projectName}...`,'
          '  outputDirectory: `apps/${projectName}/.next`,'
          '  installCommand: `yarn workspaces focus --production ${projectName} && yarn add typescript -D`,'
          '  devCommand: `yarn turbo run dev --filter=${projectName}...`,'
          '  framework: `nextjs`,'
          '  ignoreCommand: `echo always build && exit 1`',
          '  redirects: /^web-/.test(projectName)'
          '    ? [{ source: `/`, destination: `/${projectName.replace(/^web-/, ``)}` }]'
          '    : [],'
          '};'
          'writeFileSync(`vercel.json`, JSON.stringify(config, null, 2));'
          'EOF'
      - name: Deploy preview to Vercel
        run: vercel -t ${{ secrets.VERCEL_TOKEN }} | tee -a $GITHUB_STEP_SUMMARY
