name: ValidateProjects
on:
  workflow_call:
    inputs:
      projects:
        required: true
        type: string
    outputs:
      projects: ${{ jobs.validate.outputs.projects }}
jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.vars.outputs.projects }}
    steps:
      - uses: actions/checkout@v3
      - name: steps.vars.outputs.projects
        id: vars
        run: |
          export ALL_PROJECTS=$(yarn workspaces list --json | jq -csr '[ .[].name | select(. | startswith("web") ) ]')
          node <<EOF | tee -a $GITHUB_OUTPUT $GITHUB_STEP_SUMMARY
          const allProjects = JSON.parse(process.env.ALL_PROJECTS);
          const projects = process.env.PROJECTS === '*' ? null : process.env.PROJECTS.split(/,/).map(p => p.trim()).filter(p => p);
          console.log('projects=' + JSON.stringify(allProjects.filter(a => !projects || projects.includes(a))));
          EOF
        env:
          PROJECTS: ${{ inputs.projects }}
